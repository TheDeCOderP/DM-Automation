// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
  shadowDatabaseUrl = env("SHADOW_DATABASE_URL")
}

enum Platform {
  ALL
  YOUTUBE
  TIKTOK
  GOOGLE
  MEDIUM
  PINTEREST
  QUORA
  REDDIT
  LINKEDIN
  TWITTER
  FACEBOOK
  INSTAGRAM
  ZOHO_WORKDRIVE
  WORDPRESS
  HASHNODE
  DEV_TO
  CUSTOM_API
}

enum Frequency {
  IMMEDIATELY
  ONCE
  HOURLY
  DAILY
  WEEKLY
  MONTHLY
}

enum Status {
  DRAFTED
  SCHEDULED
  PUBLISHED
  FAILED
}

enum MediaType {
  IMAGE
  VIDEO
  CAROUSEL
}

enum NotificationType {
  POST_PUBLISHED
  POST_FAILED
  POST_SCHEDULED
  ACCOUNT_DISCONNECTED
  SUBSCRIPTION_RENEWAL
  GENERAL
}

enum ThemeMode {
  LIGHT
  DARK
  SYSTEM
}

enum Language {
  EN
  HI
  FR
  ES
}

enum SidebarSpacingPreset {
  NONE
  SM
  MD
  LG
}

enum SidebarIconSize {
  SM
  MD
  LG
}

enum AccordionMode {
  NONE
  SINGLE
  MULTI
}

model Account {
  id                       String   @id @default(cuid())
  userId                   String
  type                     String
  provider                 String
  providerAccountId        String
  refresh_token            String?  @db.Text
  access_token             String?  @db.Text
  expires_at               Int?
  token_type               String?
  scope                    String?
  id_token                 String?  @db.Text
  session_state            String?
  refresh_token_expires_in Int?
  createdAt                DateTime @default(now())
  updatedAt                DateTime @updatedAt
  user                     User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
  @@index([userId])
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

model User {
  id            String             @id @default(cuid())
  email         String             @unique
  name          String?
  image         String?
  password      String?
  roleId        String             @default("PCR-0002")
  emailVerified DateTime?
  createdAt     DateTime           @default(now())
  updatedAt     DateTime           @updatedAt

  resetToken        String?  // Optional, stores token
  resetTokenExpiry  DateTime? // Expiry timestamp

  notifications Notification[]
  media         Media[]
  posts         Post[]
  brands        UserBrand[]
  accounts      Account[]
  sessions      Session[]
  role          Role               @relation(fields: [roleId], references: [id], onDelete: Restrict)
  AuditLog      AuditLog[]
  blogs         Blog[]
  socialAccounts UserSocialAccount[]
  
  // Add these two relations for BrandInvitation
  sentBrandInvitations BrandInvitation[] @relation("SentBrandInvitations")
  acceptedBrandInvitations BrandInvitation[] @relation("AcceptedBrandInvitations")
}

model Brand {
  id             String                 @id @default(cuid())
  name           String
  description    String?                @db.Text
  logo           String?
  website        String?
  createdAt      DateTime               @default(now())
  updatedAt      DateTime               @updatedAt
  
  members        UserBrand[]
  posts          Post[]
  media          Media[]
  socialAccounts SocialAccountBrand[]
  brandInvitations BrandInvitation[]

  externalBlogSites ExternalBlogSite[]
}

model UserBrand {
  id        String   @id @default(cuid())
  userId    String
  brandId   String
  roleId    String   @default("PCR-0003")
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  role      Role     @relation(fields: [roleId], references: [id], onDelete: Restrict)
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  brand     Brand    @relation(fields: [brandId], references: [id], onDelete: Cascade)

  @@unique([userId, brandId])
  @@index([userId])
  @@index([brandId])
}

model SocialAccount {
  id                String                @id @default(cuid())
  platform          Platform
  accessToken       String                @db.LongText
  refreshToken      String?               @db.LongText
  tokenExpiresAt    DateTime?
  platformUserId    String
  platformUsername  String
  platformUserImage String?
  createdAt         DateTime              @default(now())
  updatedAt         DateTime              @updatedAt

  pages             SocialAccountPage[]
  brands            SocialAccountBrand[]
  users             UserSocialAccount[]

  @@unique([platform, platformUserId])
}

model UserSocialAccount {
  id              String         @id @default(cuid())
  userId          String
  socialAccountId String
  createdAt       DateTime       @default(now())
  updatedAt       DateTime       @updatedAt

  user            User           @relation(fields: [userId], references: [id], onDelete: Cascade)
  socialAccount   SocialAccount  @relation(fields: [socialAccountId], references: [id], onDelete: Cascade)

  @@unique([userId, socialAccountId])
  @@index([userId])
  @@index([socialAccountId])
}

model SocialAccountBrand {
  id              String         @id @default(cuid())
  brandId         String
  brand           Brand          @relation(fields: [brandId], references: [id], onDelete: Cascade)
  socialAccountId String
  socialAccount   SocialAccount  @relation(fields: [socialAccountId], references: [id], onDelete: Cascade)
  
  @@unique([brandId, socialAccountId])
}

model SocialAccountPage {
  id              String         @id @default(cuid())
  name            String
  pageId          String
  pageName        String
  pageImage       String?        @db.LongText
  accessToken     String         @db.LongText
  tokenExpiresAt  DateTime?
  isActive        Boolean        @default(true)
  platform        Platform       @default(FACEBOOK)
  createdAt       DateTime       @default(now())
  updatedAt       DateTime       @updatedAt
  
  socialAccountId String
  socialAccount   SocialAccount  @relation(fields: [socialAccountId], references: [id], onDelete: Cascade)

  posts           Post[]

  @@unique([pageId, socialAccountId])
  @@index([socialAccountId])
}

model Post {
  id          String     @id @default(cuid())
  userId      String
  title       String?
  content     String     @db.Text
  platform    Platform
  publishedAt DateTime?
  scheduledAt DateTime?
  frequency   Frequency?
  url         String?    @db.Text
  status      Status     @default(DRAFTED)
  createdAt   DateTime   @default(now())
  updatedAt   DateTime   @updatedAt

  media       Media[]
  analytics   PostAnalytics[]

  postGroupId String?
  postGroup   PostGroup? @relation(fields: [postGroupId], references: [id], onDelete: Cascade)

  brandId     String
  brand       Brand      @relation(fields: [brandId], references: [id], onDelete: Cascade)

  socialAccountPageId String?
  socialAccountPage   SocialAccountPage? @relation(fields: [socialAccountPageId], references: [id], onDelete: Cascade)

  user        User       @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model PostGroup {
  id          String   @id @default(cuid())
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  posts      Post[]
}

model PostAnalytics {
  id          String   @id @default(cuid())
  postId      String   @unique
  post        Post     @relation(fields: [postId], references: [id], onDelete: Cascade)
  
  // Platform-specific post identifier (the actual post ID on the platform)
  platformPostId String?
  
  // Basic engagement metrics (common across platforms)
  likes        Int      @default(0)
  comments     Int      @default(0)
  shares       Int      @default(0)
  saves        Int      @default(0)  // For Pinterest, Instagram, etc.
  clicks       Int      @default(0)
  impressions  Int      @default(0)
  reach        Int      @default(0)
  
  // Video-specific metrics
  views        Int      @default(0)
  videoPlays   Int      @default(0)
  watchTime    Int?     @default(0) // in seconds
  completionRate Float?  @default(0) // percentage
  
  // Audience metrics
  engagementRate Float?  @default(0) // calculated field
  
  // Platform-specific metrics stored as JSON for flexibility
  platformSpecificData Json?
  
  // Demographics data (can be expanded based on platform availability)
  demographics Json?
  
  // Time-series data for tracking analytics over time
  analyticsHistory Json? // Array of { timestamp: DateTime, metrics: {...} }
  
  // Timestamps
  lastSyncedAt DateTime?
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  @@index([postId])
  @@index([platformPostId])
  @@index([lastSyncedAt])
}

model Media {
  id        String    @id @default(cuid())
  url       String
  type      MediaType
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  
  postId    String
  post      Post      @relation(fields: [postId], references: [id], onDelete: Cascade)

  brandId   String 
  brand     Brand     @relation(fields: [brandId], references: [id], onDelete: Cascade)

  userId    String
  user      User      @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model Notification {
  id        String           @id @default(cuid())
  userId    String
  type      NotificationType
  title     String
  message   String
  read      Boolean          @default(false)
  metadata  Json?
  createdAt DateTime         @default(now())
  updatedAt DateTime         @updatedAt

  user      User             @relation(fields: [userId], references: [id], onDelete: Cascade)
}

enum InvitationStatus {
  PENDING
  ACCEPTED
  EXPIRED
  REVOKED
  REJECTED
}

model BrandInvitation {
  id           String           @id @default(cuid())
  brandId      String
  brand        Brand            @relation(fields: [brandId], references: [id], onDelete: Cascade)
  status       InvitationStatus @default(PENDING)
  token        String           @unique
  expiresAt    DateTime
  invitedById  String
  invitedBy    User             @relation(fields: [invitedById], references: [id], onDelete: Cascade, name: "SentBrandInvitations")
  invitedToId  String
  invitedTo    User             @relation(fields: [invitedToId], references: [id], onDelete: Cascade, name: "AcceptedBrandInvitations")
  createdAt    DateTime         @default(now())
  updatedAt    DateTime         @updatedAt

  @@unique([brandId, invitedToId, status])
  @@index([token])
  @@index([expiresAt])
  @@index([invitedById])
  @@index([invitedToId])
  @@index([brandId, invitedToId, status])
}

model Role {
  id                 String               @id @default(cuid())
  name               String               @unique
  description        String?
  isDefault          Boolean              @default(false)
  users              User[]
  permissions        RolePermission[]
  createdAt          DateTime             @default(now())
  updatedAt          DateTime             @updatedAt
  SidebarGroupAccess SidebarGroupAccess[]
  SidebarItemAccess  SidebarItemAccess[]
  RolePageAccess     RolePageAccess[]
  UserBrand          UserBrand[]

  @@unique([id])
}

model Permission {
  id          String           @id @default(cuid())
  name        String           @unique
  description String?
  roles       RolePermission[]
  createdAt   DateTime         @default(now())
  updatedAt   DateTime         @updatedAt
}

model RolePermission {
  roleId       String
  permissionId String
  role         Role       @relation(fields: [roleId], references: [id], onDelete: Cascade)
  permission   Permission @relation(fields: [permissionId], references: [id], onDelete: Cascade)

  @@id([roleId, permissionId])
  @@index([permissionId])
}

model Pages {
  id          String           @id @default(cuid())
  name        String
  path        String           @unique
  slug        String
  displayName String
  isProtected Boolean          @default(false)
  createdAt   DateTime         @default(now())
  updatedAt   DateTime         @updatedAt
  roleAccess  RolePageAccess[]
}

model RolePageAccess {
  roleId    String
  pageId    String
  hasAccess Boolean @default(true)
  page      Pages   @relation(fields: [pageId], references: [id], onDelete: Cascade)
  role      Role    @relation(fields: [roleId], references: [id], onDelete: Cascade)

  @@id([roleId, pageId]) // composite primary key
  @@index([pageId])
  @@index([roleId])
}

model Theme {
  id              String    @id @default(cuid())
  themeName       String    @unique
  primaryColor    String
  secondaryColor  String
  tertiaryColor   String
  font            String    @default("montserrat")
  logoUrl         String?
  faviconUrl      String?
  backgroundColor String?
  textColor       String?
  mode            ThemeMode @default(LIGHT)
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
}

model HeaderItem {
  id             String          @id @default(cuid())
  label          String
  href           String
  icon           String?
  subHeaderItems SubHeaderItem[]
  position       Int
  isActive       Boolean         @default(true)
  createdAt      DateTime        @default(now())
  updatedAt      DateTime        @updatedAt
}

model SubHeaderItem {
  id           String     @id @default(cuid())
  label        String
  href         String
  headerItemId String
  createdAt    DateTime   @default(now())
  updatedAt    DateTime   @updatedAt
  headerItem   HeaderItem @relation(fields: [headerItemId], references: [id])
}

model SidebarGroup {
  id        String   @id @default(cuid())
  title     String   @unique
  position  Int
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  items      SidebarItem[]
  roleAccess SidebarGroupAccess[]
}

model SidebarItem {
  id        String   @id @default(cuid())
  label     String
  href      String   @unique
  icon      String?
  position  Int
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  sidebarGroupId String
  sidebarGroup   SidebarGroup @relation(fields: [sidebarGroupId], references: [id], onDelete: Cascade)

  roleAccess SidebarItemAccess[]
}

model SidebarGroupAccess {
  roleId         String
  sidebarGroupId String
  hasAccess      Boolean      @default(true)
  sidebarGroup   SidebarGroup @relation(fields: [sidebarGroupId], references: [id], onDelete: Cascade)
  role           Role         @relation(fields: [roleId], references: [id], onDelete: Cascade)

  @@id([roleId, sidebarGroupId])
  @@index([sidebarGroupId])
  @@index([roleId])
}

model SidebarItemAccess {
  roleId        String
  sidebarItemId String
  hasAccess     Boolean     @default(true)
  sidebarItem   SidebarItem @relation(fields: [sidebarItemId], references: [id], onDelete: Cascade)
  role          Role        @relation(fields: [roleId], references: [id], onDelete: Cascade)

  @@id([roleId, sidebarItemId])
  @@index([sidebarItemId])
  @@index([roleId])
}

model SidebarSettings {
  id                  String               @id // use "singleton"
  spacingPreset       SidebarSpacingPreset @default(MD)
  spacingPx           Int?
  accordionMode       AccordionMode        @default(SINGLE)
  defaultOpenGroupIds Json?
  compact             Boolean              @default(false)
  showGroupTitles     Boolean              @default(true)
  iconSize            SidebarIconSize      @default(MD)
  createdAt           DateTime             @default(now())
  updatedAt           DateTime             @updatedAt
}


model CarouselItem {
  id          String   @id @default(cuid())
  title       String
  description String
  imageUrl    String
  buttonLabel String
  buttonHref  String
  position    Int
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

model FooterItem {
  id        String   @id @default(cuid())
  label     String
  href      String
  icon      String?
  position  Int
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model SiteConfig {
  id                         String   @id @default(cuid())
  siteName                   String   @unique
  siteDescription            String?
  domain                     String
  supportEmail               String?
  whatsappNumber             String?
  googleAnalyticsId          String?
  metaPixelId                String?
  gaPropertyId               String?
  googleCredentialsBase64    String?  @db.LongText
  // SEO fields
  metaTitle                  String?
  metaDescription            String?
  siteImageUrl               String?
  twitterHandle              String?
  ogType                     String? // e.g., website, article
  // Crawling/Indexing
  robotsEnabled              Boolean  @default(true)
  robotsDisallow             String?  @db.LongText
  robotsAllow                String?  @db.LongText
  sitemapEnabled             Boolean  @default(true)
  sitemapExtraUrls           Json?
  // Header Configuration
  headerSearchEnabled        Boolean  @default(true)
  headerNotificationsEnabled Boolean  @default(true)
  headerThemeToggleEnabled   Boolean  @default(true)
  headerLanguageEnabled      Boolean  @default(true)
  createdAt                  DateTime @default(now())
  updatedAt                  DateTime @updatedAt
}

model IdSequence {
  prefix     String   @id @unique
  lastNumber Int      @default(0)
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  @@map("id_sequences")
}

model Blog {
  id               String   @id @default(cuid())

  // Core content
  banner           String?
  title            String
  slug             String     @unique
  excerpt          String?
  content          String     @db.LongText
  tags             Json?

  // Images
  image            String?
  imageAlt         String?

  // SEO fields
  seoTitle         String?
  seoDescription   String?
  seoKeywords      String?
  canonicalUrl     String?
  structuredData   Json?
  faqs             Json?

  // Status
  published        Boolean    @default(false)
  featured         Boolean    @default(false)
  publishedAt      DateTime?

  // Relations
  authorId         String
  author           User       @relation(fields: [authorId], references: [id])

  blogPosts        BlogPost[]

  createdAt        DateTime   @default(now())
  updatedAt        DateTime   @default(now()) @updatedAt
}


enum BlogPostStatus {
  DRAFT
  PUBLISHED
  SCHEDULED
  FAILED
  SYNCED
}

// Add new model for external blog site configurations
// Add new models
model ExternalBlogSite {
  id          String   @id @default(cuid())
  name        String
  platform    Platform
  baseUrl     String
  apiEndpoint String
  apiKey      String   @db.LongText
  secretKey   String?  @db.LongText
  username    String?
  fieldMapping Json?
  authType    String   @default("API_KEY")
  contentType String   @default("application/json")
  config      Json?
  
  // Relationships
  brandId     String
  brand       Brand    @relation(fields: [brandId], references: [id], onDelete: Cascade)
  
  blogPosts   BlogPost[]
  
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  @@unique([brandId, baseUrl, platform])
  @@index([brandId])
}


// Add new model for tracking blog posts to external sites
model BlogPost {
  id                  String        @id @default(cuid())
  
  // Reference to your existing Blog model
  blogId              String
  blog                Blog          @relation(fields: [blogId], references: [id], onDelete: Cascade)
  
  // Reference to external site
  externalBlogSiteId  String
  externalBlogSite    ExternalBlogSite @relation(fields: [externalBlogSiteId], references: [id], onDelete: Cascade)
  
  // External platform post ID (if published successfully)
  externalPostId      String?
  externalPostUrl     String?       @db.Text
  
  // Status tracking
  status              BlogPostStatus @default(DRAFT)
  scheduledAt         DateTime?
  publishedAt         DateTime?
  
  // Error tracking
  errorMessage        String?       @db.Text
  retryCount          Int           @default(0)
  
  // Request/response data for debugging
  requestPayload      Json?         // The payload that was sent
  responseData        Json?         // The response received
  
  // Additional metadata
  tags                String?       // Tags for the external platform
  categories          String?       // Categories for the external platform
  featuredImage      String?       // Override featured image if needed
  
  createdAt           DateTime      @default(now())
  updatedAt           DateTime      @updatedAt
  
  @@unique([blogId, externalBlogSiteId])
  @@index([blogId])
  @@index([externalBlogSiteId])
  @@index([status])
  @@index([scheduledAt])
}

model AuditLog {
  id        String   @id @default(cuid())
  user      User?    @relation(fields: [userId], references: [id])
  userId    String?
  action    String // e.g., LOGIN_SUCCESS, LOGIN_FAILED, PASSWORD_CHANGED
  resource  String? // e.g., "/admin/settings"
  ip        String?
  userAgent String?
  metadata  Json?
  createdAt DateTime @default(now())

  @@index([userId, action, createdAt])
}



// banner management 


model Banner {
  id            String   @id @default(cuid())
  title         String
  type          String   // Slugified: "festive-ads", "sidebar-ads", etc.
  typeLabel     String?  // Human-readable: "Festive Ads", "Sidebar Ads", etc.
  imageUrl      String
  imagePublicId String?
  redirectUrl   String?
  isActive      Boolean  @default(true)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  @@index([type])
  @@index([isActive])
}